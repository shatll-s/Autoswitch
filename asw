#!/bin/bash
api="https://api.nicehash.com/api?method=simplemultialgo.info"

benchmark='
{
	"DaggerHashimoto": 0.162,
	"X16R": 0.000115,
	"Beam": 0.000155
}'

#DaggerHashimoto	BTC/TH/день
#X16R				BTC/GH/день
#Beam				BTC/kSol/день
#GrinCuckaroo29		BTC/kG/день

nh_algos='
{
	"Scrypt" : 0,
	"SHA256" : 1,
	"ScryptNf" : 2,
	"X11" : 3,
	"X13" : 4,
	"Keccak" : 5,
	"X15" : 6,
	"Nist5" : 7,
	"NeoScrypt" : 8,
	"Lyra2RE" : 9,
	"WhirlpoolX" : 10,
	"Qubit" : 11,
	"Quark" : 12,
	"Axiom" : 13,
	"Lyra2REv2" : 14,
	"ScryptJaneNf16" : 15,
	"Blake256r8" : 16,
	"Blake256r14" : 17,
	"Blake256r8vnl" : 18,
	"Hodl" : 19,
	"DaggerHashimoto" : 20,
	"Decred" : 21,
	"CryptoNight" : 22,
	"Lbry" : 23,
	"Equihash" : 24,
	"Pascal" : 25,
	"X11Gost" : 26,
	"Sia" : 27,
	"Blake2s" : 28,
	"Skunk" : 29,
	"CryptoNightV7" : 30,
	"CryptoNightHeavy" : 31,
	"Lyra2Z" : 32,
	"X16R" : 33,
	"CryptoNightV8" : 34,
	"SHA256AsicBoost" : 35,
	"Zhash" : 36,
	"Beam" : 37,
	"GrinCuckaroo29" : 38,
	"GrinCuckatoo31" : 39,
	"Lyra2REv3" : 40,
	"MTP" : 41,
	"CryptoNightR" : 42,
	"CuckooCycle" : 43
}'

echo "$(date -R) Autoswitch for NiceHash started"

bitaps_api=`curl -s https://api.bitaps.com/market/v1/ticker/btcusd`
btcusd=`echo $bitaps_api | jq '.data.last'`
[[ -z $btcusd ]] && echo "BitAPS API is not available, using default BTC price " && btcusd=12000
echo "BTC/USD $btcusd"
#echo $benchmark | jq "."
#echo $nh_algos | jq "."
benchmark_algos=(`echo $benchmark | jq -r 'keys_unsorted | .[]'`)
hr=(`echo $benchmark | jq -r '.[]'`)

nh_stats=$(echo `curl -s $api` | jq '.result.simplemultialgo[]')
echo $nh_stats > /tmp/nh_stats

for (( i=0; i < ${#benchmark_algos[@]}; i++ )); do
	algo[$i]=${benchmark_algos[$i]}
	key[$i]=`echo $nh_algos | jq ".${algo[$i]}"`
	price[$i]=`echo $nh_stats | jq -r ". | select (.algo == ${key[$i]}) | .paying"`
	profit[$i]=`echo "scale=2; x=${price[$i]} * ${hr[$i]}; if(x<1) print 0; x" | bc -l`
	
	echo "Algo: ${algo[$i]} (${key[$i]}), hr ${hr[$i]}, price ${price[$i]}, profit ${profit[$i]}"
done